name: ğŸš€ DÃ©ploiement vers Production

on:
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ RÃ©cupÃ©ration du dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Configuration de Node.js v24
        uses: actions/setup-node@v3
        with:
          node-version: 24

      - name: ğŸ“¦ Installation de pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸ“¥ Installation des dÃ©pendances
        run: pnpm install

      - name: ğŸ§± GÃ©nÃ©ration du site statique
        run: pnpm run generate
        env:
          BASE_URL: ${{ secrets.PROD_BASE_URL }}
          CDN_URL: ${{ secrets.PROD_CDN_URL }}
          BASE_EMAIL: ${{ secrets.PROD_BASE_EMAIL }}
          MANAGER_EMAIL: ${{ secrets.PROD_MANAGER_EMAIL }}
          SUPPORT_EMAIL: ${{ secrets.PROD_SUPPORT_EMAIL }}
          BASE_MOBILE: ${{ secrets.PROD_BASE_MOBILE }}
          GMAPS_KEY: ${{ secrets.PROD_GMAPS_KEY }}
          GMAPS_ID: ${{ secrets.PROD_GMAPS_ID }}

      - name: ğŸ” VÃ©rification des fichiers gÃ©nÃ©rÃ©s
        run: ls -la .output/public

      - name: âŒ Ã‰chec si .output/public est vide
        run: |
          if [ -z "$(ls -A .output/public)" ]; then
            echo "âŒ Le dossier .output/public est vide. La gÃ©nÃ©ration a Ã©chouÃ©."
            exit 1
          fi

      - name: ğŸ§¹ Nettoyage du dossier distant
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ§¹ Suppression du contenu distant..."
            rm -rf /var/www/vhosts/univerweb.dz/httpdocs/*

      - name: ğŸ“¤ DÃ©ploiement des fichiers sur le serveur
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 22
          source: .output/public/
          target: /var/www/vhosts/univerweb.dz/httpdocs
          strip_components: 2

      - name: âœ… DÃ©ploiement terminÃ© avec succÃ¨s
        run: echo "ğŸš€ Le site a Ã©tÃ© dÃ©ployÃ© avec succÃ¨s sur univerweb.dz"
